---
layout: post
title: 流量整形以及漏桶、令牌桶算法
---

# 1. 背景
在很多网络应用中，网络数据流量是不均匀的，经常存在流量突发。持续较大对流量突发超出了路由器限制会对网络服务造成影响，因此很多情况下需要对这种突发作出限制。流量整形就是一种解决流量突发的方法。

流量整形(traffic shaping)是一种限制流出网络的数据速率和突发，使数据较为均匀发送的技术。流量整形可以有效地消除流量突发，减少网络拥塞。流量整性有两个常用算法：`漏桶算法`(leaky bucket algorithm)和`令牌桶算法`(token bucket algorithm)。下面，我们将介绍这两种算法，以及这两种算法的实际应用。

# 2. 漏桶算法和令牌桶算法

## 2.1 漏桶算法(leaky bucket algorithm)
我们可以想象这样一个桶，它的底部有一个洞，只要漏桶里面有水，该桶的水就会以恒定速率R流出(向网络中发包)；如果漏桶中没有水，则出桶的速率为0。此外，如果桶内的水达到桶的容量B，此时任何进入桶的水则沿着桶壁流失。这些流失的水对应超出发送容量的报文，可能被丢弃（网络监管），而流量整形中将这些报文缓存起来，等到漏桶有余量是继续进入漏桶。

<img src="/public/post/img/TS-bucket.png" style="width: 250px;margin:auto auto;"/>

因此漏桶算法严格限制了流量的上限，在使用中存在一定局限性。

## 2.2 令牌桶算法(token bucket algorithm)
和漏桶类似，你可以想象这样的一个令牌桶：水龙头以速度R往桶里面灌水，桶的容量为B。为了发送一个数据包，需要从令牌桶中取出一个令牌，令牌总量为B；如果令牌桶是空的，则需要等待可用的令牌到达。和漏桶一样，令牌桶可以通过限制一个流的长期速率，但是允许短期内某种程度的突发传输，这是相对漏桶算法改进的地方。大量的突发将被平滑，以减少网络拥塞。

<img src="/public/post/img/TS-token-bucket.png" style="width: 400px;margin:auto auto;"/>

如上图所示，这里桶内装的是令牌而不能认为是要发送的报文，令牌释放后要以速度R入桶，入桶后才能被使用。应用产生的数据包需要拿到令牌后才能发送，否则只能进入发送队列等待令牌。当缓冲队列满时，只能将报文丢弃。而发送完的报文释放完令牌后，不能立即入桶，而是以速度R，这样可以避免过度的瞬时超发。

<img src="/public/post/img/TS-shaping-result.png" style="width: 400px;margin:auto auto;"/>

假设存在一个场景，某个应用突发产生1000Mbps的数据，并持续时间s以这个速度生成。那么这个时候可以认为是流量突发，明显是需要控制网路发送速率的。假设路由器可以在很短时间内接受峰值速率的数据，直到缓冲区填满，假设缓冲区为9600KB，远小于突发流量，缓冲区很快被占满导致包被丢弃。这里我们假设路由器最佳的工作速率为200Mbps，如果想要达到理想的工作状态，发送端的平均发送速率应该控制在200M以下。

为了避免流量突发导致的丢包，我们可以在发送端用一个令牌桶对其进行流量整形。假设数据流入速度R为200M，桶容量B为9600KB。应用产生了M=1000Mpbs的数据，最开始应用可以以1000Mpbs的速率全速发送一段时间，直至桶被填满；桶被填满后，我们需要将其发送速率削减到200Mpbs，直到突发数据被发出去。最终效果是突发量被分散到一段时间内。我们可以通过下面的共识计算允许的突发时间：

$$
B + RS = MS
$$

即：

$$
S = B/(M-R)
$$

因此只要知道了突发速率M、流出速率R、桶容量B，就可以算法最大允许的突发流量时间。

假设令牌桶的容量B=0，那么流量将被完全平滑，不允许任何突发。在使用过程中，我们可以串联两个令牌桶，第一个令牌桶允许突发，第二个令牌桶的容量B=0，通过这种方式可以达到限制峰值的目的。因为使用了令牌桶，遇到突发流量时，最开始会以最大速率M发送直至填充满令牌桶。但是人们通常希望降低峰值，并不想峰值如此高。使用这种串联方式，第一个桶的输出可以在第二个桶中继续整形，可以进一步限制发送速率。比如第一个桶开始以M=1000Mbps突发发送，桶填满后，开始以R=200Mpbs发送，第二个令牌桶B=0，R=500Mpbs，因此此时突发流量被限制到500Mpbs。因此第一个桶描述流量的平均速率，并允许突发，第二个桶限制了突发流量峰值。

## 2.3 缺点
引入了流量整形，势必会带来时延的增加，因此兼顾减少拥塞和减少时延是一个需要关注的挑战。

# 3. 总结
从上面的介绍中可以看出，流量整形的优点和缺点，可以用在我们的应用中适当使用。特别是哪些网络流量冲击比较大的应用，比如音视频会议、高并发服务系统等，通过这种削峰填谷，在控制流量的同时允许少量突发，兼顾了业务的可靠性和低延迟性。

